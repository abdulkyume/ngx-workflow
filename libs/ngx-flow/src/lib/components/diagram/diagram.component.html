<div class="ngx-flow__container">
  <svg
    #svg
    class="ngx-flow__diagram"
    (wheel)="onWheel($event)"
    (pointerdown)="onPointerDown($event)"
    (pointermove)="onPointerMove($event)"
    (pointerup)="onPointerUp($event)"
    (pointerleave)="onPointerLeave($event)"
  >
    <defs>
      <pattern
        id="ngx-flow__grid-pattern"
        x="0"
        y="0"
        width="20"
        height="20"
        patternUnits="userSpaceOnUse"
      >
        <circle cx="0.5" cy="0.5" r="0.5" fill="#ccc" />
      </pattern>

      <!-- Edge Markers -->
    <!-- Arrow marker -->
    <marker
      id="ngx-flow__arrow"
      viewBox="0 0 10 10"
      refX="9"
      refY="5"
      markerWidth="6"
      markerHeight="6"
      orient="auto-start-reverse"
    >
      <path d="M 0 0 L 10 5 L 0 10 z" fill="context-stroke" />
    </marker>

    <!-- Arrowclosed marker (filled) -->
    <marker
      id="ngx-flow__arrowclosed"
      viewBox="0 0 10 10"
      refX="10"
      refY="5"
      markerWidth="6"
      markerHeight="6"
      orient="auto-start-reverse"
    >
      <path d="M 0 0 L 10 5 L 0 10 z" fill="context-stroke" stroke="context-stroke" />
    </marker>

    <!-- Dot marker -->
    <marker
      id="ngx-flow__dot"
      viewBox="0 0 10 10"
      refX="5"
      refY="5"
      markerWidth="6"
      markerHeight="6"
    >
      <circle cx="5" cy="5" r="4" fill="context-stroke" />
    </marker>
  </defs>

  <rect
    width="100%"
    height="100%"
    fill="url(#ngx-flow__grid-pattern)"
    class="ngx-flow__background"
  />

  <g class="ngx-flow__viewport" [attr.transform]="transform">
    <!-- Edges -->
    <g *ngFor="let edge of edges(); trackBy: trackByEdgeId"
       [class.selected]="edge.selected"
       [class.animated]="edge.animated"
       class="ngx-flow__edge"
       (click)="onEdgeClick($event, edge)">
      <!-- Edge path with markers -->
      <path 
        [attr.d]="getEdgePath(edge)" 
        class="ngx-flow__edge-path" 
        [style]="edge.style"
        [attr.marker-start]="getMarkerUrl(edge.markerStart)"
        [attr.marker-end]="getMarkerUrl(edge.markerEnd)"
      ></path>
      <!-- Invisible hitbox for easier clicking -->
      <path [attr.d]="getEdgePath(edge)" class="ngx-flow__edge-hitbox"></path>
      
      <!-- Edge label -->
      <g *ngIf="edge.label" class="ngx-flow__edge-label">
        <text 
          [attr.x]="getEdgeLabelPosition(edge).x" 
          [attr.y]="getEdgeLabelPosition(edge).y"
          text-anchor="middle"
          dominant-baseline="middle"
          class="ngx-flow__edge-label-text"
          [style]="edge.labelStyle"
        >
          <!-- Label background -->
          <tspan 
            *ngIf="edge.labelBgStyle"
            class="ngx-flow__edge-label-bg"
            [style]="edge.labelBgStyle"
          ></tspan>
          {{ edge.label }}
        </text>
      </g>
    </g>

    <!-- Render temporary edges (previews) -->
    <g *ngFor="let tempEdge of tempEdges(); trackBy: trackByEdgeId"
       [class.animated]="tempEdge.animated"
       class="ngx-flow__edge">
      <path [attr.d]="getEdgePath(tempEdge, true)" class="ngx-flow__edge-path" [style]="tempEdge.style"></path>
    </g>

    <!-- Nodes -->
    <g *ngFor="let node of nodes(); trackBy: trackByNodeId"
       class="ngx-flow__node"
       [attr.data-id]="node.id"
       [class.selected]="node.selected"
       [class.dragging]="node.dragging"
       [attr.transform]="'translate(' + node.position.x + ',' + node.position.y + ')'">

      <!-- Node outline and background (visual + dragging) -->
      <rect
        [attr.width]="node.width || defaultNodeWidth"
        [attr.height]="node.height || defaultNodeHeight"
        rx="3"
        ry="3"
        class="ngx-flow__node-rect"
      ></rect>

      <!-- Dynamic content for custom nodes using ngComponentOutlet -->
      <ng-container *ngIf="getCustomNodeComponent(node.type); else defaultNodeContent">
        <ng-container
          *ngComponentOutlet="getCustomNodeComponent(node.type); inputs: { node: node }"
        ></ng-container>
      </ng-container>

      <ng-template #defaultNodeContent>
        <text x="85" y="30" text-anchor="middle" alignment-baseline="middle" class="ngx-flow__node-label">
          {{ node.data?.label || node.id }}
        </text>
      </ng-template>

      <!-- Node handles (Inlined) -->
      <!-- Top Handle -->
      <g class="ngx-flow__handle ngx-flow__handle--source ngx-flow__handle--target"
         [attr.data-nodeid]="node.id"
         data-handleid="top"
         [attr.data-type]="'source'">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" cy="-10" r="20" fill="transparent" pointer-events="all"></circle>
          <!-- Visual -->
          <circle
            [attr.cx]="(node.width || defaultNodeWidth) / 2"
            [attr.cy]="0"
            r="6"
            class="ngx-flow__handle-circle"
          ></circle>
      </g>
      <!-- Right Handle -->
      <g class="ngx-flow__handle ngx-flow__handle--source ngx-flow__handle--target"
         [attr.data-nodeid]="node.id"
         data-handleid="right"
         [attr.data-type]="'source'">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) + 10" [attr.cy]="(node.height || defaultNodeHeight) / 2" r="20" fill="transparent" pointer-events="all"></circle>
          <!-- Visual -->
          <circle
            [attr.cx]="(node.width || defaultNodeWidth)"
            [attr.cy]="(node.height || defaultNodeHeight) / 2"
            r="6"
            class="ngx-flow__handle-circle"
          ></circle>
      </g>
      <!-- Bottom Handle -->
      <g class="ngx-flow__handle ngx-flow__handle--source ngx-flow__handle--target"
         [attr.data-nodeid]="node.id"
         data-handleid="bottom"
         [attr.data-type]="'source'">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" [attr.cy]="(node.height || defaultNodeHeight) + 10" r="20" fill="transparent" pointer-events="all"></circle>
          <!-- Visual -->
          <circle
            [attr.cx]="(node.width || defaultNodeWidth) / 2"
            [attr.cy]="(node.height || defaultNodeHeight)"
            r="6"
            class="ngx-flow__handle-circle"
          ></circle>
      </g>
      <!-- Left Handle -->
      <g class="ngx-flow__handle ngx-flow__handle--source ngx-flow__handle--target"
         [attr.data-nodeid]="node.id"
         data-handleid="left"
         [attr.data-type]="'source'">
          <!-- Hit area -->
          <circle cx="-10" [attr.cy]="(node.height || defaultNodeHeight) / 2" r="20" fill="transparent" pointer-events="all"></circle>
          <!-- Visual -->
          <circle
            [attr.cx]="0"
            [attr.cy]="(node.height || defaultNodeHeight) / 2"
            r="6"
            class="ngx-flow__handle-circle"
          ></circle>
      </g>

    </g>
  </g>
</svg>

<!-- Zoom Controls (outside SVG for better event handling) -->
<ngx-zoom-controls
  *ngIf="showZoomControls"
  [zoom]="viewport().zoom"
  (zoomIn)="zoomIn()"
  (zoomOut)="zoomOut()"
  (fitView)="fitView()"
  (resetZoom)="resetZoom()"
></ngx-zoom-controls>
</div>