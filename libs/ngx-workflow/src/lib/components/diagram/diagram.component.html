<div class="ngx-workflow__container" [attr.data-lod]="lodLevel">
  <ngx-workflow-background *ngIf="showBackground" [variant]="backgroundVariant" [gap]="backgroundGap"
    [size]="backgroundSize" [color]="backgroundColor" [backgroundColor]="backgroundBgColor"></ngx-workflow-background>
  <ngx-workflow-grid-overlay *ngIf="showGrid" [gridSize]="gridSize"></ngx-workflow-grid-overlay>
  <svg #svg class="ngx-workflow__diagram" (wheel)="onWheel($event)" (pointerdown)="onPointerDown($event)"
    (dblclick)="onDiagramDoubleClick($event)">
    <defs>
      <pattern id="ngx-workflow__grid-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
        <circle cx="0.5" cy="0.5" r="0.5" fill="#ccc" />
      </pattern>

      <!-- Arrow marker -->
      <marker id="ngx-workflow__arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6"
        orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="context-stroke" />
      </marker>

      <!-- Arrowclosed marker (filled) -->
      <marker id="ngx-workflow__arrowclosed" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6"
        orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="context-stroke" stroke="context-stroke" />
      </marker>

      <!-- Dot marker -->
      <marker id="ngx-workflow__dot" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6">
        <circle cx="5" cy="5" r="4" fill="context-stroke" />
      </marker>
    </defs>

    <rect width="100%" height="100%" fill="url(#ngx-workflow__grid-pattern)" class="ngx-workflow__background" />

    <g class="ngx-workflow__viewport" [attr.transform]="transform">
      <!-- Edges -->
      <g *ngFor="let edge of filteredEdges(); trackBy: trackByEdgeId" [class.selected]="edge.selected"
        [class.animated]="edge.animated" [class.hidden]="edge.hidden" class="ngx-workflow__edge"
        (click)="onEdgeClick($event, edge)" (dblclick)="onEdgeDoubleClick($event, edge)"
        (mouseenter)="onEdgeMouseEnter($event, edge)" (mouseleave)="onEdgeMouseLeave($event, edge)">
        <!-- Edge path with markers -->
        <path [attr.d]="getEdgePath(edge)" class="ngx-workflow__edge-path" [style]="edge.style"
          [attr.marker-start]="getMarkerUrl(edge.markerStart)" [attr.marker-end]="getMarkerUrl(edge.markerEnd)">
        </path>
        <!-- Invisible hitbox for easier clicking -->
        <path [attr.d]="getEdgePath(edge)" class="ngx-workflow__edge-hitbox"></path>

        <!-- Edge label -->
        <g *ngIf="edge.label || edge.data?.labelContent || editingEdgeId === edge.id" class="ngx-workflow__edge-label">
          <!-- Editing mode (input field) -->
          <foreignObject *ngIf="editingEdgeId === edge.id" [attr.x]="getEdgeLabelPosition(edge).x - 50"
            [attr.y]="getEdgeLabelPosition(edge).y - 15" width="100" height="30">
            <input #edgeLabelInput type="text" [value]="edge.label || ''" (blur)="onEdgeLabelBlur(edge)"
              (keydown.enter)="onEdgeLabelBlur(edge)" (input)="onEdgeLabelInput($event)"
              class="ngx-workflow__edge-label-input" autofocus>
          </foreignObject>

          <!-- Custom template mode (Angular component) -->
          <foreignObject *ngIf="editingEdgeId !== edge.id && edgeLabelTemplate"
            [attr.x]="getEdgeLabelPosition(edge).x - 75" [attr.y]="getEdgeLabelPosition(edge).y - 20" width="150"
            height="40" style="pointer-events: none;">
            <div xmlns="http://www.w3.org/1999/xhtml" class="edge-label-content">
              <ng-container *ngTemplateOutlet="edgeLabelTemplate; context: { $implicit: edge, edge: edge }">
              </ng-container>
            </div>
          </foreignObject>

          <!-- Fallback to text mode -->
          <text *ngIf="editingEdgeId !== edge.id && !edgeLabelTemplate && edge.label"
            [attr.x]="getEdgeLabelPosition(edge).x" [attr.y]="getEdgeLabelPosition(edge).y" text-anchor="middle"
            dominant-baseline="middle" class="ngx-workflow__edge-label-text" [style]="edge.labelStyle">
            <!-- Label background -->
            <tspan *ngIf="edge.labelBgStyle" class="ngx-workflow__edge-label-bg" [style]="edge.labelBgStyle"></tspan>
            {{ edge.label }}
          </text>
        </g>

        <!-- Edge Update Handles -->
        <g *ngIf="edge.selected && edgeReconnectable">
          <!-- Source Handle -->
          <circle class="ngx-workflow__edge-reconnect-handle" [attr.cx]="getEdgeHandlePosition(edge, 'source').x"
            [attr.cy]="getEdgeHandlePosition(edge, 'source').y" r="8" fill="#3b82f6" stroke="white" stroke-width="2"
            style="cursor: grab; pointer-events: all;" (pointerdown)="startUpdatingEdge($event, edge, 'source')">
          </circle>
          <!-- Target Handle -->
          <circle class="ngx-workflow__edge-reconnect-handle" [attr.cx]="getEdgeHandlePosition(edge, 'target').x"
            [attr.cy]="getEdgeHandlePosition(edge, 'target').y" r="8" fill="#3b82f6" stroke="white" stroke-width="2"
            style="cursor: grab; pointer-events: all;" (pointerdown)="startUpdatingEdge($event, edge, 'target')">
          </circle>
        </g>
      </g>

      <!-- Render temporary edges (previews) -->
      <g *ngFor="let tempEdge of tempEdges(); trackBy: trackByEdgeId" [class.animated]="tempEdge.animated"
        class="ngx-workflow__edge">
        <path [attr.d]="getEdgePath(tempEdge, true)" class="ngx-workflow__edge-path" [style]="tempEdge.style"></path>
      </g>

      <!-- Selection Box (Rubber Band) -->
      <rect *ngIf="isBoxSelecting" class="ngx-workflow__selection-box" [attr.x]="getSelectionBox().x"
        [attr.y]="getSelectionBox().y" [attr.width]="getSelectionBox().width"
        [attr.height]="getSelectionBox().height" />

      <!-- Nodes -->
      <g *ngFor="let node of sortedNodes(); trackBy: trackByNodeId" class="ngx-workflow__node" [ngClass]="{
           'node-search-match': node.searchHighlight === 'match',
           'node-search-current': node.searchHighlight === 'current'
         }" [attr.aria-label]="node.label" [attr.data-id]="node.id" [class.selected]="node.selected"
        [class.dragging]="node.dragging" [class.dimmed]="node.dimmed" [class.highlighted]="node.highlighted"
        [attr.transform]="'translate(' + node.position.x + ',' + node.position.y + ')'"
        (dblclick)="onNodeDoubleClick($event, node)" (mouseenter)="onNodeMouseEnter($event, node)"
        (mouseleave)="onNodeMouseLeave($event, node)" (mousemove)="onNodeMouseMove($event, node)">

        <!-- Node outline and background (visual + dragging) -->
        <rect [attr.width]="node.width || defaultNodeWidth" [attr.height]="node.height || defaultNodeHeight" rx="3"
          ry="3" class="ngx-workflow__node-rect"></rect>

        <!-- Node Label -->
        <text *ngIf="node.type !== 'group'" [attr.x]="(node.width || defaultNodeWidth) / 2"
          [attr.y]="(node.height || defaultNodeHeight) / 2" text-anchor="middle" dominant-baseline="middle"
          class="ngx-workflow__node-label">
          {{ node.label }}
        </text>

        <!-- Top Handle -->
        <g class="ngx-workflow__handle ngx-workflow__handle--source ngx-workflow__handle--target"
          [attr.data-nodeid]="node.id" data-handleid="top" [attr.data-type]="'source'"
          (pointerdown)="onHandlePointerDown($event, node, 'top')">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" cy="-10" r="20" fill="transparent"
            pointer-events="all"></circle>
          <!-- Visual -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" [attr.cy]="0" r="6"
            class="ngx-workflow__handle-circle">
          </circle>
        </g>

        <!-- Right Handle -->
        <g class="ngx-workflow__handle ngx-workflow__handle--source ngx-workflow__handle--target"
          [attr.data-nodeid]="node.id" data-handleid="right" [attr.data-type]="'source'"
          (pointerdown)="onHandlePointerDown($event, node, 'right')">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) + 10" [attr.cy]="(node.height || defaultNodeHeight) / 2"
            r="20" fill="transparent" pointer-events="all">
          </circle>
          <!-- Visual -->
          <circle [attr.cx]="(node.width || defaultNodeWidth)" [attr.cy]="(node.height || defaultNodeHeight) / 2" r="6"
            class="ngx-workflow__handle-circle"></circle>
        </g>
        <!-- Bottom Handle -->
        <g class="ngx-workflow__handle ngx-workflow__handle--source ngx-workflow__handle--target"
          [attr.data-nodeid]="node.id" data-handleid="bottom" [attr.data-type]="'source'"
          (pointerdown)="onHandlePointerDown($event, node, 'bottom')">
          <!-- Hit area -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" [attr.cy]="(node.height || defaultNodeHeight) + 10"
            r="20" fill="transparent" pointer-events="all">
          </circle>
          <!-- Visual -->
          <circle [attr.cx]="(node.width || defaultNodeWidth) / 2" [attr.cy]="(node.height || defaultNodeHeight)" r="6"
            class="ngx-workflow__handle-circle"></circle>
        </g>
        <!-- Left Handle -->
        <g class="ngx-workflow__handle ngx-workflow__handle--source ngx-workflow__handle--target"
          [attr.data-nodeid]="node.id" data-handleid="left" [attr.data-type]="'source'"
          (pointerdown)="onHandlePointerDown($event, node, 'left')">
          <!-- Hit area -->
          <circle cx="-10" [attr.cy]="(node.height || defaultNodeHeight) / 2" r="20" fill="transparent"
            pointer-events="all"></circle>
          <!-- Visual -->
          <circle [attr.cx]="0" [attr.cy]="(node.height || defaultNodeHeight) / 2" r="6"
            class="ngx-workflow__handle-circle">
          </circle>
        </g>

        <!-- Resize Handles -->
        <g *ngIf="node.selected && (node.resizable !== false) && nodesResizable">
          <!-- NW Handle -->
          <rect class="ngx-workflow__resize-handle ngx-workflow__resize-handle-nw" data-handle="nw" [attr.x]="-5"
            [attr.y]="-5" width="10" height="10">
          </rect>
          <!-- NE Handle -->
          <rect class="ngx-workflow__resize-handle ngx-workflow__resize-handle-ne" data-handle="ne"
            [attr.x]="(node.width || defaultNodeWidth) - 5" [attr.y]="-5" width="10" height="10"></rect>
          <!-- SW Handle -->
          <rect class="ngx-workflow__resize-handle ngx-workflow__resize-handle-sw" data-handle="sw" [attr.x]="-5"
            [attr.y]="(node.height || defaultNodeHeight) - 5" width="10" height="10"></rect>
          <!-- SE Handle -->
          <rect class="ngx-workflow__resize-handle ngx-workflow__resize-handle-se" data-handle="se"
            [attr.x]="(node.width || defaultNodeWidth) - 5" [attr.y]="(node.height || defaultNodeHeight) - 5" width="10"
            height="10"></rect>


        </g>

        <!-- Group Node Template -->
        <g *ngIf="node.type === 'group'" class="ngx-workflow__group-node">
          <!-- Header -->
          <rect [attr.width]="node.width" height="30" class="ngx-workflow__group-header"></rect>
          <text [attr.x]="10" [attr.y]="20" class="ngx-workflow__group-label">{{ node.label }}</text>

          <!-- Expand/Collapse Toggle -->
          <g class="ngx-workflow__group-toggle" [attr.transform]="'translate(' + (node.width! - 25) + ', 5)'"
            (click)="toggleGroup($event, node)">
            <rect width="20" height="20" rx="4" class="ngx-workflow__group-toggle-bg"></rect>
            <path [attr.d]="node.expanded ? 'M 5 10 L 15 10' : 'M 5 10 L 15 10 M 10 5 L 10 15'"
              class="ngx-workflow__group-toggle-icon"></path>
          </g>
        </g>
      </g>

      <!-- Alignment Guides -->
      <g *ngFor="let guide of alignmentGuides()" class="ngx-workflow__alignment-guide">
        <line *ngIf="guide.type === 'horizontal'" [attr.x1]="guide.start" [attr.y1]="guide.position"
          [attr.x2]="guide.end" [attr.y2]="guide.position" />
        <line *ngIf="guide.type === 'vertical'" [attr.x1]="guide.position" [attr.y1]="guide.start"
          [attr.x2]="guide.position" [attr.y2]="guide.end" />
      </g>
    </g>

  </svg>


  <ngx-workflow-search-controls [nodes]="nodes()" (searchResults)="onSearchResults($event)"
    (resultSelected)="onSearchResultSelected($event)" (close)="onSearchClose()">
  </ngx-workflow-search-controls>

  <!-- IO Controls -->
  <div class="ngx-workflow__io-controls">
    <button (click)="exportToJSON()">Export JSON</button>
    <button (click)="triggerImport()">Import JSON</button>
    <button (click)="exportToPNG()">Export PNG</button>
    <button (click)="exportToSVG()">Export SVG</button>
  </div>

  <ngx-workflow-zoom-controls *ngIf="showZoomControls" [zoom]="viewport().zoom" [minZoom]="0.1" [maxZoom]="4"
    (zoomIn)="onZoomChange(viewport().zoom + 0.1)" (zoomOut)="onZoomChange(viewport().zoom - 0.1)"
    (fitView)="onZoomChange(1)" (resetZoom)="onZoomChange(1)"></ngx-workflow-zoom-controls>

  <ngx-workflow-export-controls *ngIf="showExportControls" (exportPNG)="exportToPNG()" (exportSVG)="exportToSVG()"
    (copyClipboard)="copyToClipboard()"></ngx-workflow-export-controls>

  <ngx-workflow-layout-controls *ngIf="showLayoutControls"
    (applyLayout)="onApplyLayout($event)"></ngx-workflow-layout-controls>

  <ngx-workflow-alignment-controls></ngx-workflow-alignment-controls>

  <ngx-workflow-minimap *ngIf="showMinimap"></ngx-workflow-minimap>

  <ngx-workflow-properties-sidebar [node]="selectedNodeForEditing" (close)="closeSidebar()"
    (change)="onPropertiesChange($event)"></ngx-workflow-properties-sidebar>

  <!-- Node Toolbars (projected content) -->
  <ng-content select="ngx-workflow-node-toolbar"></ng-content>

  <!-- Panels (projected content) -->
  <ng-content select="ngx-workflow-panel"></ng-content>

  <ngx-workflow-context-menu></ngx-workflow-context-menu>
</div>